<!DOCTYPE html>
<html>

<head>
	<title>Create Photo for Printing.</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=10 shrink-to-fit=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="theme-color" content="#09407f">
	<!-- bootstrap -->
	<link href="./assets/vendor/bootstrap/4.5.0/bootstrap.min.css" rel="stylesheet">
	<!-- cropper -->
	<link href="./assets/vendor/cropper/cropperjs/1.5.7/cropper.css" rel="stylesheet">
	<!-- style-->
	<link href="./assets/css/style.css" rel="stylesheet">
	<!-- all vendors js file-->
	<!-- jQuery -->
	<script src="./assets/vendor/jquery/3.5.1/jquery.min.js"></script>
	<!-- bootstrap bundle -->
	<script src="./assets/vendor/bootstrap/4.5.0/bootstrap.bundle.min.js"></script>
	<!-- cropperjs  -->
	<script src="./assets/vendor/cropper/cropperjs/1.5.7/cropper.min.js"></script>
	<!-- jquery-cropper [wrapper for cropperjs to use with jquery] -->
	<script src="./assets/vendor/cropper/jquery-cropper/1.0.1/jquery-cropper.min.js"></script>
	<style type="text/css">
	* {
		margin: 0;
		padding: 0;
		box-sizing: border-box;
	}
	
	body {
		height: 100vh;
		padding: 10px;
		background: #979790;
	}
	
	.d-flex {
		display: flex;
		justify-content: flex-start;
		overflow-x: auto;
	}
	
	.items {
		width: 100px;
		border: thin solid #eee;
	}
	
	.items img {
		width: 100% !important;
	}
	
	.border {
		border: thin solid #eee;
	}
	
	#A4Image {
		width: 100vw;
		border: thin solid #eee;
	}
	</style>
</head>

<body>
	<input id="input" type="file" accept="image/*">
	<br>
	<br>
	<div class="d-flex">
		<div class="items"> <img src="./img.jpg" id="orgImg"> </div>
		<div class="items ml"> <img id="stage1Image" alt="Stage 1 Image"> </div>
	</div>
	<br>
	<p id="fileInfo"></p> <img id="A4Image" alt="Stage 2 Image">
	<br>
	<br>
	<canvas id="canvas1" class="border sr-only"></canvas>
	<canvas id="A4Canvas" class="sr-only"></canvas>
	<script type="text/javascript">
	window.addEventListener('DOMContentLoaded', function() {
		//	 IMAGE LOAD SECTION ================================
		var imageInput = document.querySelector("#input");
		var fileInfo = document.querySelector("#fileInfo");
		var orgImg = document.getElementById("orgImg");
		imageInput.addEventListener("change", (event) => {
			console.time('FileOpen');
			var files = event.target.files;
			if(files && files.length > 0) {
				var file = files[0];
				console.log(file.name)
					// show file details
				fileInfo.innerHTML = "File: " + file.name;
				//fileSize.html("Size: " + ((file.size / 1024).toFixed(2)) + "KB;&nbsp&nbsp");
				var fileReaderForDataURL = new FileReader();
				fileReaderForDataURL.onloadend = function(e) {
					orgImg.src = e.target.result;
					// console image url data
					console.log(e.target.result)
						//loadCanvas();
						//setTimeout(loadCanvas(),100)
				};
				fileReaderForDataURL.readAsDataURL(file);
				var fileReaderForArrayBuffer = new FileReader();
				fileReaderForArrayBuffer.onloadend = function(evt) {
					if(evt.target.readyState === FileReader.DONE) {
						var uInt8Array = new Uint8Array(evt.target.result);
						let bytes = [];
						uInt8Array.forEach((byte) => {
							bytes.push(byte.toString(16))
						});
						var hex = bytes.join('').toUpperCase();
						mimeType = checkMimeType(hex);
					}
					console.timeEnd('FileOpen')
					loadCanvas()
				};
				var BLOB = file.slice(0, 4);
				fileReaderForArrayBuffer.readAsArrayBuffer(BLOB)
			}
		}); // load image for crop ended here.
		//	IMAGE MIME SECTION ==================================
		var checkMimeType = (signature) => {
			switch(signature) {
				case '89504E47':
					return 'image/png';
				case '47494638':
					return 'image/gif';
				case '25504446':
					return 'application/pdf';
				case 'FFD8FFDB':
				case 'FFD8FFE0':
				case 'FFD8FFE1':
					return 'image/jpeg';
				case '504B0304':
					return 'application/zip';
				default:
					return 'Unknown filetype'
			}
		};

		function loadCanvas() {
			//	var orgImg = document.getElementById("orgImg");
			var canvas1 = document.getElementById("canvas1");
			var stage1Image = document.getElementById("stage1Image");
			const jpg = "image/jpeg";
			const png = "image/png";
			const mime = jpg;
			var imageSizeUnit = 5;
			var imageRatio = 20 / 23;
			var image1Width = 200 * imageSizeUnit;
			var image1Height = image1Width / imageRatio;
			var image1Border = image1Width / 100;
			canvas1.width = image1Width;
			canvas1.height = image1Height;
			// step 1 (add border in image)
			var ctx1 = canvas1.getContext("2d");
			// this is for image border color
			ctx1.fillStyle = '#000';
			ctx1.fillRect(0, 0, image1Width, image1Height);
			// copying image
			ctx1.drawImage(orgImg, image1Border, image1Border, image1Width - image1Border * 2, image1Height - image1Border * 2);
			// add image url 
			stage1Image.src = canvas1.toDataURL(mime);
			// step 2 (arrange image for printing)
			var A4Canvas = document.getElementById("A4Canvas");
			var A4Image = document.getElementById("A4Image");
			var ctx2 = A4Canvas.getContext("2d");
			// numbers of image in a row
			var numOfRowImg = 6;
			// set image width & height
			var imageWidth = image1Width;
			var imageHeight = image1Height;
			// ser gap between images
			var imageMargin = imageWidth / 20;
			var imageMarginX = 0;
			var imageMarginY = 0;
			// whole image size will be ready for download
			var canvasWidth = numOfRowImg * (imageWidth + imageMargin);
			var canvasHeight = canvasWidth * 297 / 210; // size ratio of A4 paper size
			A4Canvas.width = canvasWidth;
			A4Canvas.height = canvasHeight;
			// because both canvas not perform once so add this in timeout method
			setTimeout(() => {
				// fill bg white
				ctx2.fillStyle = '#fff';
				ctx2.fillRect(0, 0, A4Canvas.width, A4Canvas.height);
				for(let i = 0; i < numOfRowImg; i++) {
					// copy image on canvas
					// row 1
					ctx2.drawImage(stage1Image, imageMarginX, imageMarginY, imageWidth, imageHeight);
					// row 2
					ctx2.drawImage(stage1Image, imageMarginX, (imageHeight + imageMargin), imageWidth, imageHeight);
					// row 3
					//ctx2.drawImage(stage1Image, imageMarginX, (imageHeight+imageMargin)*2, imageWidth, imageHeight);
					// row 4
					//ctx2.drawImage(stage1Image, imageMarginX, (imageHeight+imageMargin)*3, imageWidth, imageHeight);
					// every loop added image in per row distance
					imageMarginX += imageWidth + imageMargin;
				}
				// add arranged canvas to image
				A4Image.src = A4Canvas.toDataURL(mime);
			}, 10)
		}
	})
	</script>
</body>

</html>