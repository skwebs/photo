<!DOCTYPE html>
<html>

<head>
	<title>Create Photo for Printing.</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=10 shrink-to-fit=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="theme-color" content="#09407f">
	<!-- bootstrap -->
	<link href="./assets/vendor/bootstrap/4.5.2/bootstrap.min.css" rel="stylesheet">
	<!-- cropper -->
	<link href="./assets/vendor/cropper/cropperjs/1.5.7/cropper.css" rel="stylesheet">
	<!-- style-->
	<link href="./assets/css/style.css" rel="stylesheet">
	<!-- all vendors js file-->
	<!-- jQuery -->
	<script src="./assets/vendor/jquery/3.5.1/jquery.min.js"></script>
	<!-- bootstrap bundle -->
	<script src="./assets/vendor/bootstrap/4.5.2/bootstrap.bundle.min.js"></script>
	<!-- cropperjs  -->
	<script src="./assets/vendor/cropper/cropperjs/1.5.7/cropper.min.js"></script>
	<!-- jquery-cropper [wrapper for cropperjs to use with jquery] -->
	<script src="./assets/vendor/cropper/jquery-cropper/1.0.1/jquery-cropper.min.js"></script>
	<style type="text/css">
	* {
		margin: 0;
		padding: 0;
		box-sizing: border-box;
	}
	.items img {
		width: 200px !important;
	}
	
	</style>
</head>

<body class="bg-light" >
	<div class="container my-4 pb-5" style="overflow-x:hidden;" >
		<h1 class="border border-primary py-2 text-center text-primary rounded my-4" >Image Sizing</h1>
		<div class="form-group bg-white p-3">
			<label for="selectImage">Select image</label>
			<input class="form-control-file"  id="selectImage" type="file" accept="image/*">
		</div>
		
		<div class="d-flex justify-content-start my-4" style="overflow-x:auto;" >
			<div class="items"> 
				<p class="text-center" >Uploaded Image</p>
				<img src="./assets/img/no-image-selected.jpg" id="uploadedImage"> 
			</div>
			<div class="items ml-2"> 
				<p class="pl-0 text-nowrap text-center" >Border Added Image</p>
				<img id="image1" class="d-none " alt="Stage 1 Image"> 
			</div>
		</div>
		
		<label class="my-1 mr-2 mt-4" for="numberOfImageRow">Number of image row</label>
		<select class="custom-select my-1 mr-sm-2" id="numberOfImageRow">
			<option value="1">One Row</option>
			<option selected value="2">Two Rows</option>
			<option value="3">Three Rows</option>
			<option value="4">Four Rows</option>
			<option value="5">Five Rows</option>
			<option value="6">Six Rows</option>
			<option value="7">Seven Rows</option>
			<option value="8">Eight Rows</option>
			<option value="9">Nine Rows</option>
			<option value="10">Ten Rows</option>
			
		</select>
		
		<label class="my-1 mr-2 mt-4" for="numberOfImageRow">Number of image column</label>
		<select class="custom-select my-1 mr-sm-2" id="numberOfImageColumn">
			<option value="1">One Column</option>
			<option value="2">Two Columns</option>
			<option value="3">Three Columns</option>
			<option value="4">Four Columns</option>
			<option value="5">Five Columns</option>
			<option selected="selected" value="6">Six Columns</option>
			<option value="7">Seven Columns</option>
			<option value="8">Eight Columns</option>
			</select>
		
		<p id="fileInfo" class="sr-only" ></p> 
		<div class="mt-4" id="download-link" ></div>
	</div>
	<footer class="bg-dark fixed-bottom py-3 text-muted text-center" >
		<p class="m-0" >&copy <script> document.write((new Date).getFullYear());</script> Developed by <a class="text-italic text-muted h6" href="https://skwebs.github.io/" >SKWebs</a></p>
	</footer>
	<script type="text/javascript">
//	"use strict";
	window.addEventListener('DOMContentLoaded', function() {
		
		
		
		//	 IMAGE LOAD SECTION ================================
		var selectImage = document.querySelector("#selectImage");
		var fileInfo = document.querySelector("#fileInfo");
		var uploadedImage = document.getElementById("uploadedImage");
		var originalImageWidth,originalImageHeight;
		var isFileLoaded = false;
		selectImage.addEventListener("change", (event) => {
			console.time('FileOpen');
			var files = event.target.files;
			if(files && files.length > 0) {
				isFileLoaded = true;
				var file = files[0];
				console.log(file)
					// show file details
				fileInfo.innerHTML = "File: " + file.name;
				//fileSize.html("Size: " + ((file.size / 1024).toFixed(2)) + "KB;&nbsp&nbsp");
				
				// file reader for data url section
				var fileReaderForDataURL = new FileReader();
				fileReaderForDataURL.onloadend = function(e) {
					uploadedImage.src = e.target.result;
					// find image dimensions 
					var imageForDimenstion = new Image();
					imageForDimenstion.src = e.target.result;
					imageForDimenstion.onload = function () {
						originalImageHeight = this.naturalHeight || this.height;
						originalImageWidth = this.naturalWidth || this.width;
						loadCanvas();
						console.log("width :"+originalImageWidth+", height : "+originalImageHeight)
						console.log("ratio : " + imageRatio(originalImageWidth,originalImageHeight));
						
					};
					// console image url data
					console.log(e.target.result)
				};
				fileReaderForDataURL.readAsDataURL(file);
				
				// file reader for array buffer section
				var fileReaderForArrayBuffer = new FileReader();
				fileReaderForArrayBuffer.onloadend = function(evt) {
					if(evt.target.readyState === FileReader.DONE) {
						var uInt8Array = new Uint8Array(evt.target.result);
						let bytes = [];
						uInt8Array.forEach((byte) => {
							bytes.push(byte.toString(16))
						});
						var hex = bytes.join('').toUpperCase();
						mimeType = checkMimeType(hex);
					}
					console.timeEnd('FileOpen');
					//loadCanvas();
				};
				var BLOB = file.slice(0, 4);
				fileReaderForArrayBuffer.readAsArrayBuffer(BLOB)
			}
		}); 
		
		//	IMAGE MIME SECTION ==================================
		var checkMimeType = (signature) => {
			switch(signature) {
				case '89504E47':
					return 'image/png';
				case '47494638':
					return 'image/gif';
				case '25504446':
					return 'application/pdf';
				case 'FFD8FFDB':
				case 'FFD8FFE0':
				case 'FFD8FFE1':
					return 'image/jpeg';
				case '504B0304':
					return 'application/zip';
				default:
					return 'Unknown filetype'
			}
		};
		function imageRatio(w, h) {
			let gcd = hcf(w, h);
			let wr = w / gcd;
			let hr = h / gcd;
			let ratioString = wr + "/" + hr;
			return ratioString;
		}
		
		function hcf(x, y) {
			x = Math.abs(x);
			y = Math.abs(y);
			while(y) {
				let t = y;
				y = x % y;
				x = t;
			}
			return x;
		}
		
		
		var numOfRow = document.getElementById("numberOfImageRow");
		numOfRow.addEventListener("change",()=>{
			if(isFileLoaded){loadCanvas()};
		})
		
		var numOfColumn = document.getElementById("numberOfImageColumn");
			numOfColumn.addEventListener("change",()=>{
			if(isFileLoaded){loadCanvas()};
		})
		
		function loadCanvas() {
			var numberOfImageRow = numOfRow.value;
			var numberOfImageColumn = numOfColumn.value;
			var canvas1 = document.createElement("canvas"); //document.getElementById("canvas1");
			var image1 = document.getElementById("image1");
			var imageWidth = 400;
			var imageHeight = Math.round((imageWidth * originalImageHeight) / originalImageWidth );
			var imageBorder = imageWidth / 100;
			canvas1.width = imageWidth;
			canvas1.height = imageHeight;
			// step 1 (add border in image)
			var ctx1 = canvas1.getContext("2d");
			// this is for image border color
			ctx1.fillStyle = '#000';
			ctx1.fillRect(0, 0, imageWidth, imageHeight);
			// copying image
			ctx1.drawImage(uploadedImage, imageBorder, imageBorder, imageWidth - imageBorder * 2, imageHeight - imageBorder * 2);
			// add image url 
			image1.src = canvas1.toDataURL(mimeType);
			
			// step 2 (arrange image for printing)
			var A4Canvas = document.createElement("canvas") ; //document.getElementById("A4Canvas");
			// show images on loaf
			image1.classList.remove("d-none");
			
			var ctx2 = A4Canvas.getContext("2d");
			// set gap between images
			var imageMargin = imageWidth / 20;
			var imageMarginX = imageMargin;
			var imageMarginY = imageMargin;
			// whole image size will be ready for download
			var canvasWidth = numberOfImageColumn * (imageWidth + imageMargin)+imageMargin;
			var canvasHeight = canvasWidth * 297 / 210; // size ratio of A4 paper size
			A4Canvas.width = canvasWidth;
			A4Canvas.height = canvasHeight;
			
			// because both canvas not perform once so add this in timeout method
			setTimeout(() => {
				// fill bg white
				ctx2.fillStyle = '#fff';
				ctx2.fillRect(0, 0, A4Canvas.width, A4Canvas.height);
				for(let r = 0; r < numberOfImageRow; r++) {
					imageMarginX = imageMargin;
					for(let c = 0; c < numberOfImageColumn; c++) {
						ctx2.drawImage(image1, imageMarginX, imageMarginY, imageWidth, imageHeight);
						imageMarginX += imageWidth + imageMargin;
						console.log("x : "+imageMarginX+", y : "+imageMarginY)
					}
					//console.log(imageMarginY+"")
					imageMarginY += imageHeight + imageMargin;
				}
				
				// add arranged canvas to image
				var finalImageURL = A4Canvas.toDataURL(mimeType);
				document.getElementById("download-link").innerHTML = '<a href="'+finalImageURL+'" download ><center>Download image.</center> <img data-tooltip="tooltip" width="100%" title="Touch or, click on image to download." src="'+finalImageURL+'" class="border" alt=" Final image for print"></a>';
			}, 50)
		}
	})
	
	</script>
</body>


</html>